# V3.1 vs V3.2 Codebase Comparison

This document details the differences in code, structure, logic, workflow, and output between versions V3.1 and V3.2 of the multi-camera object counting system.

## Overview of Changes

The primary change in V3.2 is a refactoring of the logging mechanism, specifically how object counting logs are generated and managed. In V3.1, each consumer (CPU or GPU) was responsible for logging its own counts periodically. In V3.2, this responsibility has been centralized to the `main.py` script, which now orchestrates the collection and logging of counts from all active consumers. This change aims to provide a more consolidated and consistent logging output.

## File-by-File Comparison

### `config.yaml`

**No significant differences.** The configuration files for both versions are identical, indicating that the changes are purely in the application logic and not in the system's configurable parameters.

### `ObjectCount.py`

**No significant differences.** The core `ObjectCounter` class, responsible for the actual object counting logic, remains unchanged between V3.1 and V3.2. This means the fundamental counting algorithm and its associated methods are consistent across both versions.

### `consumer_cpu.py`

**Key Differences:**

*   **Removal of Logging Logic:**
    *   The `_check_and_log_counts` method has been removed.
    *   The `_log_counts` method has been removed.
    *   The responsibility for periodic logging has been moved to `main.py`.
*   **New Method: `get_all_camera_data()`:**
    *   A new public method `get_all_camera_data(self, force=False)` has been introduced. This method is responsible for collecting the current count data (in_count, out_count, classwise_counts) for all cameras managed by this consumer. It also handles resetting counts if `reset_after_log` is enabled and `force` is `False`. This method is called by `main.py` to retrieve data for consolidated logging.
*   **Minor Change in `_process_batch`:**
    *   A `logger.info` line that reported batch processing time has been commented out. This is likely to reduce log verbosity, especially when `main.py` is now handling consolidated logging.

**Impact on Workflow:**

The CPU consumer no longer independently decides when to log counts. Instead, it exposes its current counting state through `get_all_camera_data()` to `main.py`, which then aggregates and logs this information.

### `consumer_gpu.py`

**Key Differences:**

*   **Removal of Logging Logic:**
    *   The `_check_and_log_counts` method has been removed.
    *   The `_log_counts` method has been removed.
    *   Similar to `consumer_cpu.py`, the responsibility for periodic logging has been moved to `main.py`.
*   **New Method: `get_all_camera_data()`:**
    *   A new public method `get_all_camera_data(self, force=False)` has been introduced, mirroring the change in `consumer_cpu.py`. This method collects the current count data for all cameras and handles count resetting.
*   **Minor Change in `_process_batch_gpu_optimized`:**
    *   A `logger.info` line that reported batch processing time has been commented out, similar to the CPU consumer.

**Impact on Workflow:**

The GPU consumer, like its CPU counterpart, no longer independently logs counts. It provides its counting state to `main.py` via `get_all_camera_data()` for centralized logging.

### `main.py`

**Key Differences:**

*   **New Function: `log_consolidated_counts(camera_data, log_dir, force=False)`:**
    *   This is a new top-level function responsible for taking the aggregated camera data (from `consumer.get_all_camera_data()`) and formatting it into a consolidated JSON log file. It also handles console logging for final summaries.
*   **Centralized Periodic Logging:**
    *   The `MultiCameraCounting.start()` method now includes a new loop that periodically calls `self.consumer.get_all_camera_data()` and then `log_consolidated_counts()`. This centralizes the logging decision and execution.
    *   The `self.last_log_time` attribute has been added to `MultiCameraCounting` to manage the timing of these periodic logs.
*   **Consolidated Final Logging:**
    *   Before the pipeline stops, `main.py` now explicitly calls `self.consumer.get_all_camera_data(force=True)` and `log_consolidated_counts(..., force=True)` to ensure all final counts are logged in a consolidated manner.
*   **Updated `_print_status()`:**
    *   The `_print_status` method now retrieves counting status using `self.consumer.get_status()` instead of directly accessing `self.consumer.object_counters` and its internal attributes. This promotes better encapsulation.
*   **Import `json`:**
    *   The `json` module is now imported to support the new `log_consolidated_counts` function.

**Impact on Workflow:**

`main.py` now acts as the central orchestrator for logging. It pulls count data from the consumers and generates a single, consolidated log file, improving the overall logging workflow and consistency.

### `producer.py`

**No significant differences.** The `FrameProducer` class, responsible for capturing frames from cameras and pushing them into a queue, remains identical between V3.1 and V3.2. This indicates that the frame acquisition and preprocessing pipeline is stable.

## Summary of Logic and Workflow Changes

*   **Centralized Logging:** The most significant change is the shift from distributed logging (each consumer logging its own counts) to centralized logging (main.py collecting and logging counts from all consumers).
*   **Improved Encapsulation:** Consumers now expose their counting data through a dedicated `get_all_camera_data()` method, rather than `main.py` directly accessing their internal state. This improves the modularity and encapsulation of the consumer classes.
*   **Consolidated Log Output:** Instead of multiple log files per camera (or mixed logs), V3.2 aims to produce a single, consolidated JSON log file at each logging interval, containing data for all active cameras. This simplifies log analysis.
*   **Consistent Final Counts:** The explicit final logging step in `main.py` ensures that all accumulated counts are recorded before the application shuts down, regardless of the last periodic log interval.

## Output Differences

*   **Log File Structure:** In V3.1, each consumer would generate its own log entries (and potentially files) for each camera. In V3.2, there will be a single JSON log file generated at each interval (and at shutdown) that contains the counting data for *all* cameras, structured under a single timestamp.
*   **Console Output:** The console output related to periodic and final counts will also reflect this consolidation, with `main.py` printing a summary for all cameras rather than individual consumers printing their own.
*   **Reduced Redundancy:** The commented-out `logger.info` lines in the consumer classes suggest an intention to reduce redundant logging, focusing the detailed count logs into the consolidated JSON files.